<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Connect Telegram</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          "Helvetica Neue",
          Arial;
        background: #fff;
        color: #111;
        margin: 0;
        padding: 24px;
      }
      .wrap {
        max-width: 720px;
        margin: 32px auto;
        text-align: center;
      }
      h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }
      p {
        color: #444;
      }
      .btn {
        display: inline-block;
        margin: 12px;
        padding: 12px 18px;
        border-radius: 8px;
        background: #0b89ff;
        color: #fff;
        text-decoration: none;
        font-weight: 600;
      }
      .muted {
        color: #666;
        margin-top: 8px;
      }
      .small {
        font-size: 13px;
        color: #666;
      }
      .actions {
        margin-top: 20px;
      }
      .note {
        margin-top: 18px;
        color: #333;
        background: #f7f9fc;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #eef2f8;
      }
      .copy {
        background: #e6eefc;
        color: #0b59b0;
        border-radius: 6px;
        padding: 6px 8px;
        cursor: pointer;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Opening Telegram...</h1>
      <p class="muted">
        If Telegram opened on your device, go to the bot chat and press <strong>Start</strong>. If
        nothing happened, use the buttons below.
      </p>

      <div class="actions">
        <a id="open-app" class="btn">Open in Telegram app</a>
        <a id="open-web" class="btn" style="background: #222; margin-left: 8px">Open in browser</a>
      </div>

      <div class="note" id="stateNote">Preparing...</div>

      <div style="margin-top: 12px" class="small">
        Tip: if you're on desktop and nothing happens, open Telegram, search for the bot username
        and press Start.
      </div>

      <div style="margin-top: 18px">
        <button id="close" style="padding: 8px 12px; border-radius: 6px">Close</button>
      </div>
    </div>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const appUrl = params.get("appUrl") || "";
        const authUrl = params.get("authUrl") || "";
        // Limit displayed strings to safe printable text and short length
        const safe = s =>
          String(s || "")
            .replace(/[\u0000-\u001f]/g, "")
            .slice(0, 200);
        const state = params.get("state") || "";
        const bot = params.get("bot") || "";
        const openApp = document.getElementById("open-app");
        const openWeb = document.getElementById("open-web");
        const note = document.getElementById("stateNote");
        const closeBtn = document.getElementById("close");

        note.textContent = bot
          ? `Bot: ${safe(bot)} · State: ${safe(state)}`
          : `State: ${safe(state)}`;

        // Only allow safe targets — strict validation for tg:// and HTTPS Telegram domains
        function isAllowedTelegramUrl(url) {
          if (!url || typeof url !== "string") return false;
          url = url.trim();

          // Validate tg:// protocol with strict pattern
          if (url.startsWith("tg://")) {
            return /^tg:\/\/[a-zA-Z0-9_\-\/\?=&]+$/.test(url);
          }

          // Only allow HTTPS URLs from whitelisted Telegram domains
          try {
            const u = new URL(url);
            if (u.protocol !== "https:") return false;
            const allowed = ["t.me", "web.telegram.org"];
            return allowed.includes(u.hostname);
          } catch (_) {}
          return false;
        }

        // Validate and sanitize URLs before use
        const validAppUrl = isAllowedTelegramUrl(appUrl) ? appUrl : "";
        const validAuthUrl = isAllowedTelegramUrl(authUrl) ? authUrl : "";

        // Sanitize URLs to prevent XSS - encode any special characters
        const sanitizeUrl = function (u) {
          if (!u) return "#";
          // Only allow telegram:// or https:// schemes
          if (!u.startsWith("telegram://") && !u.startsWith("https://")) return "#";
          // Additional validation: ensure it passes allowlist check
          if (!isAllowedTelegramUrl(u)) return "#";
          return u.replace(/[<>"'`]/g, "");
        };

        // Strict redirect function that double-checks validation
        const safeRedirect = function (url) {
          if (!url || !isAllowedTelegramUrl(url)) return false;
          const sanitized = sanitizeUrl(url);
          if (sanitized === "#") return false;
          // Final validation: ensure sanitized URL is still safe
          if (!sanitized.startsWith("telegram://") && !sanitized.startsWith("https://"))
            return false;
          if (!isAllowedTelegramUrl(sanitized)) return false;
          try {
            window.location.href = sanitized;
            return true;
          } catch (_) {
            return false;
          }
        };

        openApp.href = sanitizeUrl(validAppUrl) || sanitizeUrl(validAuthUrl) || "#";
        openApp.onclick = function (e) {
          e.preventDefault();
          const targetUrl = validAppUrl || validAuthUrl;
          safeRedirect(targetUrl);
          return false;
        };

        openWeb.href = sanitizeUrl(validAuthUrl) || sanitizeUrl(validAppUrl) || "#";
        openWeb.onclick = function (e) {
          const href = openWeb.href;
          if (
            !href ||
            href === "#" ||
            !href.startsWith("https://") ||
            !isAllowedTelegramUrl(href)
          ) {
            e.preventDefault();
            return false;
          }
          // Allow navigation only to validated URLs
          return true;
        };

        closeBtn.onclick = function () {
          window.close();
        };

        // Auto-attempt native open on load (non-blocking) - only if strictly validated
        if (validAppUrl && isAllowedTelegramUrl(validAppUrl)) {
          setTimeout(function () {
            safeRedirect(validAppUrl);
          }, 300);
        }

        // If the opener exists on same-origin, request it to check status periodically.
        const origin = window.location.origin;
        let interval = null;
        function requestStatus() {
          try {
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({ type: "telegram:status:check", state }, origin);
            }
          } catch (_) {}
        }

        // Listen for response from opener
        window.addEventListener("message", ev => {
          try {
            if (ev.origin !== origin) return; // only accept same-origin replies
            const d = ev.data || {};
            if (d.type === "telegram:status:response") {
              if (d.connected) {
                // Show confirmation then close using safe DOM apis (avoid innerHTML when adding text)
                try {
                  const el = document.createElement("div");
                  el.style.padding = "40px";
                  el.style.textAlign = "center";
                  el.style.fontFamily = "system-ui";
                  el.style.fontSize = "18px";
                  el.textContent = "Connected — closing…";
                  while (document.body.firstChild)
                    document.body.removeChild(document.body.firstChild);
                  document.body.appendChild(el);
                } catch (_) {
                  // Fallback: attempt to create a simplified text-only node safely
                  try {
                    while (document.body.firstChild)
                      document.body.removeChild(document.body.firstChild);
                    const fallback = document.createElement("div");
                    fallback.textContent = "Connected — closing…";
                    document.body.appendChild(fallback);
                  } catch (_) {
                    // As a last resort, set body textContent
                    document.body.textContent = "Connected — closing…";
                  }
                }
                setTimeout(() => {
                  try {
                    window.close();
                  } catch (_) {}
                }, 500);
              }
            }
          } catch (_) {}
        });

        // Start asking opener to check status every 1.5s for up to 2 minutes
        interval = setInterval(requestStatus, 1500);
        setTimeout(() => {
          clearInterval(interval);
          interval = null;
        }, 120000);
      })();
    </script>
  </body>
</html>
