name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    # Make required encryption keys available to the job from repository secrets.
    # Note: secrets are NOT provided to workflows triggered by forked PRs for security.
    env:
      GENERIC_TOKEN_ENCRYPTION_KEY: ${{ secrets.GENERIC_TOKEN_ENCRYPTION_KEY }}
      FUNCTIONS_TOKEN_ENCRYPTION_KEY: ${{ secrets.FUNCTIONS_TOKEN_ENCRYPTION_KEY }}
      TWITTER_TOKEN_ENCRYPTION_KEY: ${{ secrets.TWITTER_TOKEN_ENCRYPTION_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install root deps
        run: |
          npm ci
      - name: Install functions deps
        run: |
          cd autopromote-functions
          npm ci
      - name: Validate @grpc/grpc-js version unification
        run: |
          npm ls @grpc/grpc-js --json > grpc-list.json || true
          node -e "const fs=require('fs'); const o=JSON.parse(fs.readFileSync('grpc-list.json','utf8')); const versions=new Set(); function scan(n){ if(!n || !n.dependencies) return; for(const k of Object.keys(n.dependencies)){ const d=n.dependencies[k]; if(k==='@grpc/grpc-js'){ versions.add(d.version); } scan(d); } } scan(o); if(versions.size===0){ console.log('No @grpc/grpc-js found'); } else if(versions.size===1){ console.log('Unified @grpc/grpc-js version:', [...versions][0]); } else { console.error('Multiple @grpc/grpc-js versions found:', [...versions].join(', ')); process.exit(1); }"
        - name: Check installed grpc internals (root)
          run: |
            npm run check:grpc-install || true
      - name: Secrets presence diagnostic
        run: |
          if [ -z "${{ secrets.GENERIC_TOKEN_ENCRYPTION_KEY }}" ]; then echo "GENERIC: MISSING"; else echo "GENERIC: PRESENT"; fi
          if [ -z "${{ secrets.FUNCTIONS_TOKEN_ENCRYPTION_KEY }}" ]; then echo "FUNCTIONS: MISSING"; else echo "FUNCTIONS: PRESENT"; fi
          if [ -z "${{ secrets.TWITTER_TOKEN_ENCRYPTION_KEY }}" ]; then echo "TWITTER: MISSING"; else echo "TWITTER: PRESENT"; fi
      - name: Preflight & Unit Tests
        # Only run preflight for PRs that originate from this repository (not forks), or non-PR events
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
        run: |
          npm run preflight
          npm run test:unit
      - name: Route Import Tests
        run: |
          CI_ROUTE_IMPORTS=1 npm run test:routes
