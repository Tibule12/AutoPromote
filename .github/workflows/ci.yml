name: CI

# Explicit permissions so reporter can create Check Runs for internal PRs
permissions:
  contents: read
  actions: read
  checks: write

on:
  workflow_dispatch: # Allow manual runs for debugging and CI rechecks
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci_debug_info:
    name: CI debug info
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Print environment info
        run: |
          echo "CI Debug Info"
          echo "----------------"
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref: $GITHUB_REF"
          echo "SHA: $GITHUB_SHA"
          echo "Actor: $GITHUB_ACTOR"
          echo "Repo: $GITHUB_REPOSITORY"
          node -v || true
          npm -v || true
      - name: List npm cache and lockfile
        run: |
          echo "Working dir: $(pwd)"
          echo "Files:"
          ls -la | head -n 50
          echo "Show package.json top lines"
          head -n 50 package.json || true
      - name: Show grpc package info in repo (if installed)
        run: |
          if [ -d node_modules/@grpc/grpc-js ]; then
            ls -la node_modules/@grpc/grpc-js | head -n 50 || true
            node -e "try { const pkg=require('@grpc/grpc-js/package.json'); console.log('installed', pkg.version); } catch(e) { console.error('not installed', e.message); }" || true
          else
            echo "@grpc/grpc-js not installed in repo workspace yet"
          fi
    if: always()
  build-and-test:
    runs-on: ubuntu-latest
    # Make required encryption keys available to the job from repository secrets.
    # Note: secrets are NOT provided to workflows triggered by forked PRs for security.
    env:
      GENERIC_TOKEN_ENCRYPTION_KEY: ${{ secrets.GENERIC_TOKEN_ENCRYPTION_KEY }}
      FUNCTIONS_TOKEN_ENCRYPTION_KEY: ${{ secrets.FUNCTIONS_TOKEN_ENCRYPTION_KEY }}
      TWITTER_TOKEN_ENCRYPTION_KEY: ${{ secrets.TWITTER_TOKEN_ENCRYPTION_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install root deps
        run: |
          npm ci
      - name: Install functions deps
        run: |
          cd autopromote-functions
          npm ci
      - name: Validate @grpc/grpc-js version unification
        run: |
          npm ls @grpc/grpc-js --json > grpc-list.json || true
          node -e "const fs=require('fs'); const o=JSON.parse(fs.readFileSync('grpc-list.json','utf8')); const versions=new Set(); function scan(n){ if(!n || !n.dependencies) return; for(const k of Object.keys(n.dependencies)){ const d=n.dependencies[k]; if(k==='@grpc/grpc-js'){ versions.add(d.version); } scan(d); } } scan(o); if(versions.size===0){ console.log('No @grpc/grpc-js found'); } else if(versions.size===1){ console.log('Unified @grpc/grpc-js version:', [...versions][0]); } else { console.error('Multiple @grpc/grpc-js versions found:', [...versions].join(', ')); process.exit(1); }"
      - name: "CI debug: Node & grpc install info"
        run: |
          set -o pipefail
          echo "CI debug: Node/NPM versions"
          node -v || true
          npm -v || true
          echo "Listing @grpc/grpc-js info (npm ls)"
          npm ls @grpc/grpc-js --long || true
          echo "Print @grpc/grpc-js package.json if resolvable"
          node -e "try{ const pkg = require('@grpc/grpc-js/package.json'); console.log('@grpc/grpc-js@' + pkg.version + ' at ' + require.resolve('@grpc/grpc-js')) } catch(e){ console.warn('not-installed: ' + (e && e.message)) }"
          echo "List build/src paths for @grpc/grpc-js"
          ls -la node_modules/@grpc/grpc-js/build/src || true
          echo "Check for presence of single-subchannel-channel.js"
          if [ -f node_modules/@grpc/grpc-js/build/src/single-subchannel-channel.js ]; then echo 'single-subchannel-channel: PRESENT'; else echo 'single-subchannel-channel: MISSING'; fi
          # Run our safety check script to surface missing internal file (non-fatal)
          node ./scripts/check-grpc-install.js || true
      - name: Check installed grpc internals (root)
        run: |
          npm run check:grpc-install || true
      
      - name: "Preflight & Unit Tests"
        # Only run preflight for PRs that originate from this repository (not forks), or non-PR events.
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        run: |
          npm run preflight
          npm run test:unit
      - name: Route Import Tests
        run: |
          CI_ROUTE_IMPORTS=1 npm run test:routes

      - name: Integration Tests
        env:
          FIREBASE_ADMIN_BYPASS: 1
          JEST_JUNIT_OUTPUT: test-results/junit.xml
        run: |
          # Run integration tests using the installed jest and env vars provided above
          # Use --testPathPattern to avoid shell/glob misinterpretation and ensure Jest selects only integration tests
          npx jest --runInBand --testTimeout=30000 --reporters=default --reporters=jest-junit --testPathPatterns "src/.*/__tests__/.*\\.integration\\.test\\.js$" -i

      - name: Upload test-results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-test-results
          path: test-results/junit.xml

      - name: Annotate PR with test results (internal PRs only)
        # Only run reporter for pull requests originating from this repository (not forks)
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        uses: dorny/test-reporter@v2
        with:
          name: JEST Tests
          path: test-results/junit.xml
          reporter: jest-junit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Slack on CI failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_ALERT_WEBHOOK_URL }}
        run: |
          echo "Preparing Slack notification..."
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "No SLACK_ALERT_WEBHOOK_URL configured; skipping Slack notification"
            exit 0
          fi
          JOB_NAME="${{ github.job }}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          ACTOR="${{ github.actor }}"
          STATUS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PAYLOAD=$(cat <<EOF
          {"text":":rotating_light: *CI Failure* in ${REPO} \nJob: ${JOB_NAME} \nTriggered by: ${ACTOR} \nRun: <${STATUS_URL}|#${RUN_ID}>"}
          EOF
          )
          curl -s -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK" || echo "Slack notify failed"

  lint:
    name: Lint codebase (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Run ESLint
        run: npm run lint
