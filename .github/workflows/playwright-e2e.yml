name: Playwright E2E

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 5 * * *' # daily smoke tests at 05:00 UTC

jobs:
  playwright-e2e:
    runs-on: ubuntu-latest
    env:
      FIREBASE_ADMIN_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_ADMIN_SERVICE_ACCOUNT }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      FUNCTIONS_TOKEN_ENCRYPTION_KEY: ${{ secrets.FUNCTIONS_TOKEN_ENCRYPTION_KEY }}
      GENERIC_TOKEN_ENCRYPTION_KEY: ${{ secrets.GENERIC_TOKEN_ENCRYPTION_KEY }}
      RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      TWITTER_TOKEN_ENCRYPTION_KEY: ${{ secrets.TWITTER_TOKEN_ENCRYPTION_KEY }}
      ENABLE_TEST_USAGE_NO_DB: '1'
      FIREBASE_ADMIN_BYPASS: '1'
      BYPASS_ACCEPTED_TERMS: '1'
      CI_ROUTE_IMPORTS: '1'
      CORS_ALLOW_ALL: 'true'
      OPENAI_LOGGING_ENABLED: '1'
    strategy:
      matrix:
        node-version: [20]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Check for FIREBASE Admin service account (cloud vs emulator)
        id: check_firebase_secret
        shell: bash
        run: |
          if [ -n "$FIREBASE_ADMIN_SERVICE_ACCOUNT_BASE64" ] || [ -n "$FIREBASE_ADMIN_SERVICE_ACCOUNT" ]; then
            echo "run-tests=cloud" >> $GITHUB_OUTPUT
            echo "Found Firebase service account secret. Will run E2E tests against cloud service account.";
          else
            echo "run-tests=emulator" >> $GITHUB_OUTPUT
            echo "No Firebase service account secret found. Will run E2E tests using the Firebase emulator.";
          fi
      - name: Prepare playwright browsers
        run: npx playwright install --with-deps
      - name: Upload test reporters directory (pre-clean)
        run: rm -rf test-results || true
      - name: Cloud seed Firestore (if cloud mode)
        if: steps.check_firebase_secret.outputs.run-tests == 'cloud'
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/test/e2e/tmp/service-account.json
        run: |
          # Ensure service account exists and is written
          node ./scripts/write-service-account.js || true
          node ./scripts/seed-autopilot-cloud.js
      - name: Run Playwright E2E (cloud)
        if: steps.check_firebase_secret.outputs.run-tests == 'cloud'
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/test/e2e/tmp/service-account.json
        run: npm run test:e2e:playwright
      - name: Run Playwright E2E (emulator)
        if: steps.check_firebase_secret.outputs.run-tests == 'emulator'
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          GCLOUD_PROJECT: autopromote-cc6d3
        run: |
          # Use firebase emulators:exec to ensure the emulator environment variables are set for the child process
          npx firebase emulators:exec --only firestore --project autopromote-cc6d3 "node ./scripts/seed-autopilot-emulator.js && npm run test:e2e:playwright:emulator"
      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-report
          path: |
            test-results/**
            playwright-report/**
            test/e2e/**/playwright-report/**
      - name: Cleanup service account
        if: always()
        run: |
          rm -f test/e2e/tmp/service-account.json || true
          echo "Cleaned up test/e2e/tmp/service-account.json"
      - name: Run smoke tests (daily)
        if: github.event_name == 'schedule'
        run: |
          node ./tools/smoke-tests/runSmokeTests.js
          echo "Running Jest canary smoke tests (TikTok gating)"
          npx jest src/services/__tests__/promotion_canary.test.js --runInBand --silent
