name: Functions Emulator Smoke Tests

on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  smoke-tests:
    name: Emulator Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      FIREBASE_PROJECT: autopromote-cc6d3
      GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa.json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm ci

      - name: Fail if `FIREBASE_ADMIN_SERVICE_ACCOUNT` not set
        if: ${{ !secrets.FIREBASE_ADMIN_SERVICE_ACCOUNT }}
        run: |
          echo "ERROR: FIREBASE_ADMIN_SERVICE_ACCOUNT secret is not set. Add the service account secret to repository secrets and retry.";
          exit 1
        shell: bash

      - name: Confirm secret is present
        if: ${{ secrets.FIREBASE_ADMIN_SERVICE_ACCOUNT }}
        run: echo "FIREBASE_ADMIN_SERVICE_ACCOUNT is present"

      - name: Write service account
        if: ${{ secrets.FIREBASE_ADMIN_SERVICE_ACCOUNT }}
        run: |
          set -euo pipefail
          echo "$GITHUB_WORKSPACE" && echo "Writing service account from secret"
          SECRET_CONTENT="${{ secrets.FIREBASE_ADMIN_SERVICE_ACCOUNT }}"
          # If the secret starts with '{' assume it's raw JSON, otherwise treat as base64
          if printf "%s" "$SECRET_CONTENT" | head -c 1 | grep -q '{'; then
            printf "%s" "$SECRET_CONTENT" > "$GITHUB_WORKSPACE/sa.json"
          else
            printf "%s" "$SECRET_CONTENT" | base64 --decode > "$GITHUB_WORKSPACE/sa.json"
          fi
          ls -al "$GITHUB_WORKSPACE/sa.json"
        shell: bash

      - name: Set GOOGLE_APPLICATION_CREDENTIALS
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa.json
        run: echo "Using GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"

      - name: Run emulator smoke test
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa.json
        run: |
          set -o pipefail
          npx firebase emulators:exec --project $FIREBASE_PROJECT --only functions,firestore,storage "node scripts/seed-autopilot-emulator.js && node scripts/test-landing-page-trigger.js" 2>&1 | tee emulator-test.log

      - name: Upload emulator logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: emulator-test.log
