// Snippet showing token handling and encryption before storage (from src/routes/facebookRoutes.js)
let stored = {
  provider: 'facebook',
  token_type: tokenData.token_type,
  expires_in: tokenData.expires_in,
  pages,
  ig_business_account_id: igBusinessAccountId,
  obtainedAt: admin.firestore.FieldValue.serverTimestamp(),
};
try {
  const { encryptToken, hasEncryption } = require('../services/secretVault');
  if (hasEncryption()) {
    stored.encrypted_user_access_token = encryptToken(tokenData.access_token);
    stored.user_access_token = admin.firestore.FieldValue.delete();
    stored.hasEncryption = true;
  } else {
    stored.user_access_token = tokenData.access_token;
    stored.hasEncryption = false;
  }
} catch (e) {
  stored.user_access_token = tokenData.access_token; // fallback
}
await db.collection('users').doc(uidFromState).collection('connections').doc('facebook').set(stored, { merge: true });

// Also shows migration that moves plaintext tokens to encrypted_user_access_token and deletes plaintext field when encryption becomes available.
