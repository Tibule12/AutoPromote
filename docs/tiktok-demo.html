<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AutoPromote — TikTok Integration Demo</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:0;color:#222}
    header{background:#111;color:#fff;padding:18px 20px}
    .container{max-width:900px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:22px}
    .card{border:1px solid #e6e6e6;border-radius:8px;padding:16px;margin-bottom:16px;background:#fff}
    pre{background:#f7f7f7;padding:12px;border-radius:6px;overflow:auto}
    .small{font-size:13px;color:#555}
    footer{padding:18px 20px;font-size:13px;color:#666}
    @media (max-width:600px){.container{padding:0 12px}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>AutoPromote — TikTok Integration (Sandbox demo)</h1>
      <div class="small">This page is for reviewers: it explains what we demonstrate in the demo video and shows privacy & contact info.</div>
    </div>
  </header>
  <main class="container">
    <section class="card">
      <h2>What this demo shows</h2>
      <ul>
        <li>OAuth login with TikTok (Sandbox) — consent screen with scopes visible.</li>
        <li>Exchange of code for an access token (sandbox exchange).</li>
        <li>Publishing a sandbox video (content sharing) and displaying result.</li>
        <li>Reading analytics for the sandbox content (analytics scope).</li>
      </ul>
      <p class="small">Sandbox Client ID shown below is injected from the deployment environment.</p>
  <pre id="sandbox-client" style="background:#fff;border:1px dashed #ddd;padding:8px;border-radius:6px">Sandbox Client ID: {{TIKTOK_SANDBOX_CLIENT_KEY}}</pre>
  <div id="exchange-result" style="margin-top:12px;display:none;background:#f1f1f1;padding:8px;border-radius:6px;font-family:monospace;white-space:pre-wrap"></div>
      <script>
        // Show sandbox client id. Priority:
        // 1) query param `key` or `client_key` (for local recordings)
        // 2) server-injected placeholder ({{TIKTOK_SANDBOX_CLIENT_KEY}})
        // 3) show NOT SET message
        (function(){
          try {
            const el = document.getElementById('sandbox-client');
            if (!el) return;
            const params = new URLSearchParams(window.location.search);
            const qKey = (params.get('key') || params.get('client_key') || '').trim();
            if (qKey) {
              el.textContent = 'Sandbox Client ID: ' + qKey;
              return;
            }
            // fallback to server-injected value if present
            const text = el.textContent || '';
            if (text.indexOf(':') !== -1) {
              const parts = text.split(':');
              const value = parts.slice(1).join(':').trim();
              if (!value || value === '{{TIKTOK_SANDBOX_CLIENT_KEY}}') {
                el.innerHTML = 'Sandbox Client ID: <strong style="color:#c00">NOT SET</strong>\n\n(This server-side env var TIKTOK_SANDBOX_CLIENT_KEY is not configured on this instance)';
              }
            }
          } catch (e) { /* ignore */ }
        })();
      </script>
    </section>

    <!-- Recorder UI: allows a reviewer or you to record the screen while following the demo -->
    <section class="card" id="recorder-card">
      <h2>Quick recorder (optional)</h2>
      <p class="small">You can record this demo directly from your browser. Click <strong>Start recording</strong>, choose the screen or window to capture, then perform the demo steps. When finished click <strong>Stop recording</strong> and download the WebM file.</p>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="rec-start" style="padding:8px 12px;border-radius:6px;background:#0b66ff;color:#fff;border:0;cursor:pointer">Start recording</button>
        <button id="rec-stop" disabled style="padding:8px 12px;border-radius:6px;background:#d9534f;color:#fff;border:0;cursor:pointer">Stop recording</button>
        <button id="rec-download" disabled style="padding:8px 12px;border-radius:6px;background:#28a745;color:#fff;border:0;cursor:pointer">Download</button>
        <button id="connect-mock" style="padding:8px 12px;border-radius:6px;background:#6f42c1;color:#fff;border:0;cursor:pointer">Connect (Mock)</button>
        <span id="rec-status" style="margin-left:8px;color:#555;font-size:13px">Idle</span>
      </div>
      <p class="small" style="margin-top:8px">Notes: Browsers require you to choose which screen or tab to share. The recorder will capture what you select. The output is a WebM file which you can convert to MP4 if desired.</p>
    </section>

    <script>
      // If the page was opened with a code query param, perform a mock exchange and show the result
      (async function(){
        try {
          const params = new URLSearchParams(window.location.search);
          const code = params.get('code');
          const clientKey = params.get('client_key') || params.get('key');
          if (code) {
            const resultEl = document.getElementById('exchange-result');
            resultEl.style.display = 'block';
            resultEl.textContent = 'Exchanging code...';
            const resp = await fetch('http://localhost:8082/oauth/exchange', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code: code, client_key: clientKey || 'X', client_secret: 'Y', redirect_uri: window.location.origin + window.location.pathname })
            });
            const json = await resp.json();
            resultEl.textContent = JSON.stringify(json, null, 2);
          }
        } catch(e) { console.error('exchange failed', e); }
      })();
    </script>

    <section class="card">
      <h2>Demo video script & timestamps</h2>
      <p class="small">Follow this script when recording. Keep the video short and clear (2–4 minutes recommended).</p>
      <pre>
0:00–0:08  — Title card: "AutoPromote — TikTok Production Review (Sandbox demo)"
0:08–0:18  — Show TikTok Developer Portal app page (Sandbox mode), highlight app name.
0:18–0:28  — Show App settings -> Website URL and Redirect URIs (https://www.autopromote.org)
0:28–0:45  — Show Privacy & Terms pages on the domain
0:45–1:10  — Start AutoPromote -> Click "Sign in with TikTok" (show OAuth request URL or button)
1:10–1:30  — Show TikTok consent screen with requested scopes listed
1:30–1:45  — Accept consent -> show app receiving auth code or token
1:45–2:10  — Call user profile endpoint (user.info scope) and show returned sample data
2:10–2:40  — Upload or create a sandbox video (upload scope); show success response / sandbox ID
2:40–2:50  — Fetch analytics for the sandbox video (analytics scope) and show sample metrics
2:50–3:00  — Closing slide: contact info and confirmation that all scopes were demonstrated
      </pre>
    </section>

    <section class="card">
      <h2>Scopes requested</h2>
      <ul>
        <li>user.info.basic — read user profile</li>
        <li>video.upload — publish video to sandbox</li>
        <li>analytics.read — read analytics for content</li>
      </ul>
      <p class="small">Only scopes demonstrated in the video were requested. If a scope is not demonstrated, we removed it before submission.</p>
    </section>

    <section class="card">
      <h2>Privacy & Data Handling (short)</h2>
      <p class="small">AutoPromote only stores tokens needed to perform actions on behalf of users. We never share user personal tokens with third parties. Data used for analytics is aggregated and retained only as long as needed. Read full policy at <a href="/privacy">/privacy</a>.</p>
    </section>

    <section class="card">
      <h2>Contact</h2>
  <p class="small">If you need more details, contact us: support@autopromote.org</p>
    </section>

    <section class="card">
      <h2>Resubmission notes (paste into TikTok review)</h2>
      <pre>
Thank you for the review. We updated the Website URL to https://www.autopromote.org and verified Redirect URIs, privacy and terms pages on the same domain. We used TikTok Sandbox for the demo and removed unused scopes. The attached video demonstrates OAuth login, the consent screen listing requested scopes, code/token exchange, a sandbox video upload, and analytics calls for that sandbox video. Please let us know if you require anything further. — AutoPromote team
      </pre>
    </section>

  </main>
  <footer>
    AutoPromote • Demo page for TikTok review • Last changed: 2025-10-19
  </footer>
</body>
</html>
<script>
  // In-page screen recorder using MediaRecorder
  (function(){
    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) return;
    let mediaRecorder, recordedChunks = [];
    const startBtn = document.getElementById('rec-start');
    const stopBtn = document.getElementById('rec-stop');
    const dlBtn = document.getElementById('rec-download');
    const status = document.getElementById('rec-status');

    startBtn && startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: 'always' }, audio: true });
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9,opus' });
        mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          status.textContent = 'Recording stopped';
          dlBtn.disabled = false;
          // Stop all tracks of the stream to release screen capture
          try { stream.getTracks().forEach(t => t.stop()); } catch(e){}
        };
        mediaRecorder.start(1000);
        startBtn.disabled = true; stopBtn.disabled = false; dlBtn.disabled = true;
        status.textContent = 'Recording...';
      } catch (e) {
        status.textContent = 'Permission denied or capture failed';
      }
    });

    stopBtn && stopBtn.addEventListener('click', () => {
      try {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      } catch (e) {}
      startBtn.disabled = false; stopBtn.disabled = true;
    });

    dlBtn && dlBtn.addEventListener('click', () => {
      if (!recordedChunks || !recordedChunks.length) return;
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none'; a.href = url; a.download = 'autopromote-tiktok-demo.webm';
      document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
      dlBtn.disabled = true; status.textContent = 'Downloaded';
    });
    // Open the local mock OAuth page for demos where sandbox.tiktok.com is unreachable
    const connectMockBtn = document.getElementById('connect-mock');
    if (connectMockBtn) {
      connectMockBtn.addEventListener('click', ()=>{
        // open the mock OAuth frontend served from docs/mock
        window.open('/mock/tiktok_oauth_frontend.html', '_blank');
      });
    }
  })();
</script>